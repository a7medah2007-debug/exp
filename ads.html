<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Rewards | كسب المكافآت</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --neon: #00d2ff; --bg: #050a15; --card-bg: rgba(255, 255, 255, 0.05); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background: var(--bg); 
            color: white; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 15px;
        }
        
        .card { 
            background: var(--card-bg); 
            border: 1px solid var(--neon); 
            padding: 25px 20px; 
            border-radius: 20px; 
            text-align: center; 
            width: 100%; 
            max-width: 400px; 
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.1); 
            backdrop-filter: blur(10px);
        }

        #balance { 
            font-size: clamp(2.5rem, 10vw, 3.2rem); 
            font-weight: 900; 
            color: var(--neon); 
            text-shadow: 0 0 10px var(--neon); 
            margin: 5px 0 15px 0; 
        }
        
        .ad-viewport { 
            width: 100%; 
            min-height: 250px; 
            background: #000; 
            border-radius: 12px; 
            margin: 20px 0; 
            border: 1px solid #1e293b; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            overflow: hidden;
        }

        #timer-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 5px 12px;
            border-radius: 20px;
            color: var(--neon);
            font-size: 0.8rem;
            border: 1px solid var(--neon);
            display: none;
            z-index: 10;
        }
        
        button { 
            width: 100%; 
            padding: 16px; 
            border-radius: 12px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 1rem; 
            transition: 0.2s; 
        }

        #startBtn { background: transparent; border: 2px solid var(--neon); color: var(--neon); margin-bottom: 10px; }
        #startBtn:disabled { border-color: #333; color: #555; cursor: not-allowed; }
        
        #rewardBtn { 
            background: var(--neon); 
            color: #000; 
            display: none; 
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); 
        }

        #msg { margin-top: 15px; font-size: 0.9rem; color: var(--neon); min-height: 20px; }
        .stats { margin-top: 20px; font-size: 0.75rem; opacity: 0.5; display: flex; justify-content: space-between; width: 100%; }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--neon);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #backBtn { 
    background: rgba(255, 255, 255, 0.05); 
    border: 1px solid rgba(255, 255, 255, 0.2); 
    color: #ccc; 
    margin-bottom: 15px;
    font-size: 0.85rem;
    padding: 10px;
}
#backBtn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

    </style>
</head>
<body>

    <div class="card">
        <div style="font-size: 0.75rem; opacity: 0.6;">إجمالي النقاط المكتسبة</div>
        <div id="balance">0.00</div>
        
        <div class="ad-viewport" id="adContainer">
            <div id="timer-overlay">30s</div>
            <div id="ad-slot">
                <p style="color:#4a5568; font-size:0.8rem;">بانتظار بدء المهمة...</p>
            </div>
        </div>

        <button id="startBtn" onclick="runVideoProcess()">بدء مشاهدة الإعلان</button>
        <button id="rewardBtn" onclick="collectReward()">استلام المكافأة الآن</button>
<button id="backBtn" onclick="window.location.href='index.html'">العودة للرئيسية</button>

        <div id="msg">جاري تحميل البيانات...</div>
        
        <div class="stats">
            <span>المهمات: <b id="dailyCount">0 / 15</b></span>
            <span>الحالة: <b id="userStatus">متصل</b></span>
        </div>
    </div>
<script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth-compat.js"></script>



<script>
// إعدادات فايربيز (كما هي)
const firebaseConfig = {
    apiKey: "AIzaSyBKXxVqGiL0Ml_kEeNzchzHUMYPsFyl-jM",
    authDomain: "rewardsite-9025d.firebaseapp.com",
    projectId: "rewardsite-9025d",
    storageBucket: "rewardsite-9025d.firebasestorage.app",
    messagingSenderId: "777911247728",
    appId: "1:777911247728:web:089c8f41a1684c35d7a5b5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let userUID = null;
let isLocked = false; 

const BANNER_CODES = [
    `<script type="text/javascript">atOptions = { 'key' : 'bd100f5de33bb8359ef151eb1e7eecef', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };<\/script><script type="text/javascript" src="//www.highperformanceformat.com/invoke.js"><\/script>`,
    `<div id="monetag-ad-inner"></div><script src="https://nap5k.com/tag.min.js" data-zone="10586190" async><\/script>`,
    `<script async="async" data-cfasync="false" src="https://ballisticcomainvitation.com/f86cc21e3cdaf12feaeabbc84a827ca1/invoke.js"><\/script>`
];

const DIRECT_LINKS = [
    "https://ballisticcomainvitation.com/k0eagxazc?key=003f66bbb890eceef1381c08b579649f", 
    "https://otieu.com/4/10586232" 
];

function getRandomDirectLink() {
    return DIRECT_LINKS[Math.floor(Math.random() * DIRECT_LINKS.length)];
}

function displayRandomBanner() {
    const slot = document.getElementById('ad-slot');
    if(!slot) return;
    try {
        const randomCode = BANNER_CODES[Math.floor(Math.random() * BANNER_CODES.length)];
        const range = document.createRange();
        const fragment = range.createContextualFragment(randomCode);
        slot.innerHTML = ""; 
        slot.appendChild(fragment);
    } catch(e) { console.log("Ad render skipped"); }
}

auth.onAuthStateChanged(user => {
    if (user) { 
        userUID = user.uid; 
        startSync(); 
        setTimeout(displayRandomBanner, 3000); 
    } else {
        document.getElementById('msg').innerText = "يرجى تسجيل الدخول أولاً";
    }
});

function startSync() {
    if(!userUID || isLocked) return;
    db.collection("users").doc(userUID).onSnapshot(doc => {
        if (!doc.exists || isLocked) return;
        const data = doc.data();
        document.getElementById('balance').innerText = (data.balance || 0).toFixed(2);
        document.getElementById('dailyCount').innerText = `${data.videosWatchedToday || 0} / 15`;
        
        const lastTime = data.lastAdTime ? data.lastAdTime.toMillis() : 0;
        const diff = Date.now() - lastTime;

        if (data.videosWatchedToday >= 15) {
            updateUI("انتهت مهمات اليوم!", true);
        } else if (diff < 30000 && diff > 0) {
            updateUI(`انتظر للتحضير...`, true);
            // لا نحتاج لإعادة استدعاء startSync هنا لأن onSnapshot يراقب التغييرات تلقائياً
        } else {
            updateUI("جاهز لبدء المهمة", false);
        }
    }, err => { console.error("Sync Error"); });
}

function runVideoProcess() {
    isLocked = true; // قفل المزامنة لمنع تداخل البيانات أثناء العد
    document.getElementById('startBtn').disabled = true;
    document.getElementById('timer-overlay').style.display = 'block';
    let timeLeft = 30; 
    const timerDisplay = document.getElementById('timer-overlay');
    updateUI("⏳يرجي مشاهده الاعلان بالكامل..", true);

    const countdown = setInterval(() => {
        timerDisplay.innerText = timeLeft + "s";
        timeLeft--;
        if (timeLeft < 0) {
            clearInterval(countdown);
            timerDisplay.style.background = "#22c55e";
            timerDisplay.innerText = "جاهز!";
            document.getElementById('rewardBtn').style.display = 'block';
            updateUI("اضغط بالأسفل لاستلام المكافأة", true);
        }
    }, 1000);
}

async function collectReward() {
    if (!userUID) return;
    const rewardBtn = document.getElementById('rewardBtn');
    const chosenLink = getRandomDirectLink();
    
    const newWindow = window.open(chosenLink, '_blank');
<script>
// إعدادات فايربيز (كما هي)
const firebaseConfig = {
    apiKey: "AIzaSyBKXxVqGiL0Ml_kEeNzchzHUMYPsFyl-jM",
    authDomain: "rewardsite-9025d.firebaseapp.com",
    projectId: "rewardsite-9025d",
    storageBucket: "rewardsite-9025d.firebasestorage.app",
    messagingSenderId: "777911247728",
    appId: "1:777911247728:web:089c8f41a1684c35d7a5b5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let userUID = null;
let isLocked = false; 

// المصفوفة (كما هي)
const BANNER_CODES = [
    `<script type="text/javascript">atOptions = { 'key' : 'bd100f5de33bb8359ef151eb1e7eecef', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };<\/script><script type="text/javascript" src="//www.highperformanceformat.com/invoke.js"><\/script>`,
    `<div id="monetag-ad-inner"></div><script src="https://nap5k.com/tag.min.js" data-zone="10586190" async><\/script>`,
    `<script async="async" data-cfasync="false" src="https://ballisticcomainvitation.com/f86cc21e3cdaf12feaeabbc84a827ca1/invoke.js"><\/script>`
];

const DIRECT_LINKS = [
    "https://ballisticcomainvitation.com/k0eagxazc?key=003f66bbb890eceef1381c08b579649f", 
    "https://otieu.com/4/10586232" 
];

function getRandomDirectLink() {
    return DIRECT_LINKS[Math.floor(Math.random() * DIRECT_LINKS.length)];
}

function displayRandomBanner() {
    const slot = document.getElementById('ad-slot');
    if(!slot) return;
    const randomCode = BANNER_CODES[Math.floor(Math.random() * BANNER_CODES.length)];
    try {
        const range = document.createRange();
        const fragment = range.createContextualFragment(randomCode);
        slot.innerHTML = ""; 
        slot.appendChild(fragment);
    } catch(e) { slot.innerHTML = randomCode; }
}

auth.onAuthStateChanged(user => {
    if (user) { 
        userUID = user.uid; 
        startSync(); 
        setTimeout(displayRandomBanner, 3000); 
    } else {
        document.getElementById('msg').innerText = "يرجى تسجيل الدخول أولاً";
    }
});

function startSync() {
    if(!userUID) return;
    db.collection("users").doc(userUID).onSnapshot(doc => {
        if (!doc.exists) {
            document.getElementById('msg').innerText = "خطأ: لم يتم العثور على حسابك";
            return;
        }
        if (isLocked) return;
        const data = doc.data();
        document.getElementById('balance').innerText = (data.balance || 0).toFixed(2);
        document.getElementById('dailyCount').innerText = `${data.videosWatchedToday || 0} / 15`;
        const lastTime = data.lastAdTime ? data.lastAdTime.toMillis() : 0;
        const diff = Date.now() - lastTime;

        if (data.videosWatchedToday >= 15) {
            updateUI("انتهت مهمات اليوم!", true);
        } else if (diff < 30000 && diff > 0) {
            updateUI(`انتظر للتحضير...`, true);
            setTimeout(startSync, 30000 - diff + 1000);
        } else {
            updateUI("جاهز لبدء المهمة", false);
            isLocked = false; 
        }
    });
}

function runVideoProcess() {
    isLocked = true; 
    document.getElementById('startBtn').disabled = true;
    document.getElementById('timer-overlay').style.display = 'block';
    let timeLeft = 30; 
    const timerDisplay = document.getElementById('timer-overlay');
    updateUI("⏳يرجي مشاهده الاعلان بالكامل..", true);

    const countdown = setInterval(() => {
        timerDisplay.innerText = timeLeft + "s";
        timeLeft--;
        if (timeLeft < 0) {
            clearInterval(countdown);
            timerDisplay.style.background = "#22c55e";
            timerDisplay.innerText = "جاهز!";
            document.getElementById('rewardBtn').style.display = 'block';
            updateUI("اضغط بالأسفل لاستلام المكافأة", true);
        }
    }, 1000);
}

// --- [ التعديل الجديد: نظام الـ 10 ثواني ] ---
async function collectReward() {
    if (!userUID) return;
    const rewardBtn = document.getElementById('rewardBtn');
    const chosenLink = getRandomDirectLink();
    
    // فتح الإعلان فوراً لضمان عدم حظره من المتصفح
    const newWindow = window.open(chosenLink, '_blank');
    rewardBtn.style.display = 'none';

    let waitTime = 10;
    const timerInterval = setInterval(() => {
        updateUI(`<div class="loader"></div> جاري التحقق من الزيارة.. يرجي البقاء داخل النافذه الجديده لثواني ، انتظر ${waitTime} ثوانٍ`, true);
        waitTime--;

        if (waitTime < 0) {
            clearInterval(timerInterval);
            // إرسال البيانات بعد انتهاء الوقت
            saveRewardToFirebase(chosenLink, newWindow);
        }
    }, 1000);
}

async function saveRewardToFirebase(link, win) {
    updateUI('<div class="loader"></div> جاري إضافة النقاط...', true);
    try {
        await db.collection("users").doc(userUID).update({
            balance: firebase.firestore.FieldValue.increment(1.0),
            videosWatchedToday: firebase.firestore.FieldValue.increment(1),
            lastAdTime: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        updateUI("✅ تمت إضافة 1.00 نقطة!", false);
        setTimeout(() => { location.reload(); }, 1000);
    } catch(e) {
        updateUI("❌ فشل التسجيل، حاول مرة أخرى", false);
        document.getElementById('rewardBtn').style.display = 'block';
    }
}

function updateUI(text, btnState) {
    document.getElementById('msg').innerHTML = text;
    document.getElementById('startBtn').disabled = btnState;
}
</script>




</body>
</html>
