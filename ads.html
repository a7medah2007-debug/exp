<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Rewards | مشاهدة الفيديو</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --neon: #00d2ff; --bg: #050a15; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 10px; }
        
        .card { background: rgba(255,255,255,0.05); border: 1px solid var(--neon); padding: 20px; border-radius: 15px; text-align: center; width: 100%; max-width: 450px; }
        
        /* حاوية الفيديو - أهم جزء */
        .video-container {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
            border: 1px solid #333;
        }

        iframe { border: none; width: 100%; height: 100%; }

        #timer-bar {
            position: absolute;
            top: 0; left: 0; height: 4px;
            background: var(--neon);
            width: 0%;
            transition: linear;
        }

        button { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #startBtn { background: var(--neon); color: #000; }
        #startBtn:disabled { background: #333; color: #777; }
        #collectBtn { background: #2ecc71; color: white; display: none; }
        
        #status-text { font-size: 0.8rem; color: var(--neon); margin-top: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="balance-display">الرصيد: <span id="balance">0.00</span></div>
        
        <div class="video-container" id="videoWrapper">
            <div id="timer-bar"></div>
            <div id="ad-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #444;">
                الفيديو سيظهر هنا عند البدء
            </div>
        </div>

        <button id="startBtn" onclick="initVideoTask()">بدء مشاهدة الفيديو</button>
        <button id="collectBtn" onclick="addPoints()">استلام النقاط ✅</button>
        
        <div id="status-text">اضغط على الزر لبدء المهمة</div>
    </div>

<script>
// إعدادات Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBKXxVqGiL0Ml_kEeNzchzHUMYPsFyl-jM",
    authDomain: "rewardsite-9025d.firebaseapp.com",
    projectId: "rewardsite-9025d",
    storageBucket: "rewardsite-9025d.firebasestorage.app",
    messagingSenderId: "777911247728",
    appId: "1:777911247728:web:089c8f41a1684c35d7a5b5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ضع هنا كود Onclicka البرمجي (السكربت فقط)
const VIDEO_SCRIPT_CODE = `ضع هنا كود السكربت الذي أعطته لك شركة Onclicka بالكامل`;

let userUID = null;
let countdown;

auth.onAuthStateChanged(user => { if(user) { userUID = user.uid; updateBalance(); } });

function updateBalance() {
    db.collection("users").doc(userUID).get().then(doc => {
        if(doc.exists) document.getElementById('balance').innerText = doc.data().balance.toFixed(2);
    });
}

function initVideoTask() {
    const wrapper = document.getElementById('videoWrapper');
    document.getElementById('startBtn').disabled = true;
    document.getElementById('status-text').innerText = "⏳ جاري تحميل الفيديو...";

    // إنشاء الـ iframe وحقن الكود بداخله لضمان التنفيذ
    const ifrm = document.createElement('iframe');
    wrapper.innerHTML = '<div id="timer-bar"></div>'; // مسح المحتوى القديم
    wrapper.appendChild(ifrm);

    const ifrmDoc = ifrm.contentWindow.document;
    ifrmDoc.open();
    // نقوم بكتابة الكود داخل الـ iframe مباشرة
    ifrmDoc.write(`
        <html>
            <body style="margin:0; background:black; display:flex; align-items:center; justify-content:center;">
                ${VIDEO_SCRIPT_CODE}
            </body>
        </html>
    `);
    ifrmDoc.close();

    startTimer();
}

function startTimer() {
    let timeLeft = 15;
    const bar = document.getElementById('timer-bar');
    bar.style.width = "0%";
    
    countdown = setInterval(() => {
        timeLeft--;
        let progress = ((15 - timeLeft) / 15) * 100;
        bar.style.width = progress + "%";
        document.getElementById('status-text').innerText = `ابقَ في الصفحة.. متبقي ${timeLeft} ثانية`;

        if (timeLeft <= 0) {
            clearInterval(countdown);
            document.getElementById('status-text').innerText = "✅ اكتمل الفيديو! يمكنك استلام النقاط";
            document.getElementById('collectBtn').style.display = "block";
        }
    }, 1000);
}

// حماية من الغش
document.addEventListener("visibilitychange", () => {
    if (document.hidden && countdown) {
        clearInterval(countdown);
        alert("❌ تم إلغاء المهمة لأنك غادرت الصفحة!");
        location.reload();
    }
});

async function addPoints() {
    try {
        await db.collection("users").doc(userUID).update({
            balance: firebase.firestore.FieldValue.increment(1.0),
            videosWatchedToday: firebase.firestore.FieldValue.increment(1)
        });
        alert("تم إضافة 1.00 نقطة!");
        location.reload();
    } catch(e) { alert("خطأ في الاتصال"); }
}
</script>

</body>
</html>
